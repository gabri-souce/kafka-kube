---
- name: Kafka Error Report
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - ../group_vars/all.yml

  tasks:

    - name: Banner Errore
      debug:
        msg:
          - "ÔøΩÔøΩ ============================================"
          - "üî¥   KAFKA HEALTH CHECK - FALLITO!"
          - "üî¥ ============================================"
          - "   Cluster:   {{ kafka_cluster_name }}"
          - "   Namespace: {{ k8s_namespace }}"
          - "üî¥ ============================================"

    - name: Raccogli stato pod
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
      register: all_pods
      ignore_errors: true

    - name: Mostra pod in errore
      debug:
        msg: "‚ùå POD IN ERRORE: {{ item.metadata.name }} ‚Üí {{ item.status.phase }}"
      loop: "{{ all_pods.resources | default([]) }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      when: item.status.phase not in ['Running', 'Succeeded']

    - name: Raccogli stato Kafka
      kubernetes.core.k8s_info:
        api_version: kafka.strimzi.io/v1beta2
        kind: Kafka
        name: "{{ kafka_cluster_name }}"
        namespace: "{{ k8s_namespace }}"
      register: kafka_status
      ignore_errors: true

    - name: Mostra condizioni Kafka
      debug:
        msg: "‚ö†Ô∏è  KAFKA: {{ item.type }} = {{ item.status }} ({{ item.message | default('nessun messaggio') }})"
      loop: "{{ kafka_status.resources[0].status.conditions | default([]) }}"
      loop_control:
        label: "{{ item.type }}"
      ignore_errors: true

    - name: Report Finale
      debug:
        msg:
          - "üî¥ ============================================"
          - "   AZIONE RICHIESTA:"
          - "   kubectl get pods -n {{ k8s_namespace }}"
          - "   kubectl describe pod <nome-pod> -n {{ k8s_namespace }}"
          - "   kubectl logs <nome-pod> -n {{ k8s_namespace }}"
          - "üî¥ ============================================"

    - name: Forza fallimento per visibilit√† in AWX
      fail:
        msg: "Health Check fallito - vedi dettagli sopra"

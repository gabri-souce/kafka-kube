{{- if .Values.kafka.enabled }}
{{- range .Values.kafkaUsers }}
---
# ============================================================================
# EXTERNAL SECRET per {{ .name }}
# ============================================================================
# External Secret che recupera la password da Vault
# e crea automaticamente il Secret Kubernetes
{{- if $.Values.vault.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .name }}-password
  namespace: {{ include "kafka-lab.namespace" $ }}
  labels:
    {{- include "kafka-lab.labels" $ | nindent 4 }}
    app.kubernetes.io/component: kafka-user-secret
    kafka-user: {{ .name }}
spec:
  # Refresh automatico dei secret da Vault
  refreshInterval: {{ $.Values.vault.refreshInterval | default "1h" }}
  
  # Secret Store di riferimento
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  
  # Secret Kubernetes da creare
  target:
    name: {{ .name }}-password
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          {{- include "kafka-lab.labels" $ | nindent 10 }}
          kafka-user: {{ .name }}
      data:
        password: "{{ `{{ .password }}` }}"
  
  # Mappatura dei dati da Vault
  data:
    - secretKey: password
      remoteRef:
        # Path completo: <kvPath>/<vaultSecretPath>
        # Es: secret/data/kafka/users/admin
        key: {{ .vaultSecretPath }}
        property: password
{{- end }}

---
# ============================================================================
# KAFKA USER: {{ .name }}
# ============================================================================
apiVersion: kafka.strimzi.io/v1beta2
kind: KafkaUser
metadata:
  name: {{ .name }}
  namespace: {{ include "kafka-lab.namespace" $ }}
  labels:
    strimzi.io/cluster: {{ $.Values.kafka.name }}
    {{- include "kafka-lab.labels" $ | nindent 4 }}
spec:
  authentication:
    type: {{ .type }}
    password:
      valueFrom:
        secretKeyRef:
          name: {{ .name }}-password
          key: password
  authorization:
    type: simple
    acls:
      {{- range .acls }}
      - resource:
          type: {{ .resource.type }}
          {{- if .resource.name }}
          name: {{ .resource.name | quote }}
          {{- end }}
          {{- if .resource.patternType }}
          patternType: {{ .resource.patternType }}
          {{- end }}
        operations:
          {{- range .operations }}
          - {{ . }}
          {{- end }}
        host: "*"
      {{- end }}
{{- end }}
{{- end }}

{{- if .Values.vault.enabled }}
# ============================================================================
# VAULT SECRET STORE
# ============================================================================
# Configurazione del Secret Store per External Secrets Operator
# Definisce come connettersi a Vault e autenticarsi
# ============================================================================

---
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: {{ include "kafka-lab.namespace" . }}
  labels:
    {{- include "kafka-lab.labels" . | nindent 4 }}
    app.kubernetes.io/component: vault-secretstore
spec:
  provider:
    vault:
      # Server Vault
      server: {{ .Values.vault.address | quote }}
      # Path del KV engine (v2)
      path: {{ .Values.vault.kvPath | quote }}
      # Versione KV engine
      version: v2
      
      # Autenticazione Kubernetes
      auth:
        kubernetes:
          # Path del Kubernetes auth method in Vault
          mountPath: kubernetes
          # Role configurato in Vault per questo namespace
          role: {{ .Values.vault.auth.role | quote }}
          # Service Account usato per l'autenticazione
          serviceAccountRef:
            name: {{ .Values.vault.auth.serviceAccount }}
          
          # Token reviewer JWT (opzionale, usa il default se non specificato)
          # secretRef:
          #   name: vault-token-reviewer
          #   key: token
{{- end }}
